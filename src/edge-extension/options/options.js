/*
 * PTA EdgeÊã°ÂºµÊ©üËÉΩ - Ë®≠ÂÆö„Çπ„ÇØ„É™„Éó„Éà
 * Copyright (c) 2024 PTA Development Team
 */

// DOMË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÊôÇ„ÅÆÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
    initializeOptions();
});

/**
 * Ë®≠ÂÆöÁîªÈù¢„ÅÆÂàùÊúüÂåñ
 */
function initializeOptions() {
    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
    document.getElementById('provider').addEventListener('change', handleProviderChange);
    document.getElementById('test-connection').addEventListener('click', testConnection);
    document.getElementById('save-settings').addEventListener('click', saveSettings);
    document.getElementById('reset-settings').addEventListener('click', resetSettings);
    document.getElementById('export-settings').addEventListener('click', exportSettings);
    document.getElementById('import-settings').addEventListener('click', importSettings);
    document.getElementById('export-history').addEventListener('click', exportHistory);
    document.getElementById('clear-all-data').addEventListener('click', clearAllData);
    document.getElementById('import-file').addEventListener('change', handleImportFile);
    
    // ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
    loadSettings();
    loadStatistics();
}

/**
 * „Éó„É≠„Éê„Ç§„ÉÄ„ÉºÂ§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜ
 */
function handleProviderChange() {
    const provider = document.getElementById('provider').value;
    const azureSettings = document.getElementById('azure-settings');
    
    if (provider === 'azure') {
        azureSettings.style.display = 'block';
    } else {
        azureSettings.style.display = 'none';
    }
}

/**
 * Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
 */
function loadSettings() {
    chrome.storage.local.get(['pta_settings'], (result) => {
        const settings = result.pta_settings || {
            provider: 'azure',
            model: 'gpt-4',
            apiKey: '',
            azureEndpoint: '',
            autoDetect: true,
            showNotifications: true,
            saveHistory: true
        };
        
        // UIË¶ÅÁ¥†„Å´Ë®≠ÂÆöÂÄ§„ÇíÂèçÊò†
        document.getElementById('provider').value = settings.provider || 'azure';
        document.getElementById('model').value = settings.model || 'gpt-4';
        document.getElementById('api-key').value = settings.apiKey || '';
        document.getElementById('azure-endpoint').value = settings.azureEndpoint || '';
        document.getElementById('auto-detect').checked = settings.autoDetect !== false;
        document.getElementById('show-notifications').checked = settings.showNotifications !== false;
        document.getElementById('save-history').checked = settings.saveHistory !== false;
        
        // „Éó„É≠„Éê„Ç§„ÉÄ„ÉºË®≠ÂÆö„ÅÆË°®Á§∫Âà∂Âæ°
        handleProviderChange();
    });
}

/**
 * Áµ±Ë®àÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø
 */
function loadStatistics() {
    chrome.storage.local.get(['pta_history', 'pta_statistics'], (result) => {
        const history = result.pta_history || [];
        
        // Ëß£Êûê„Éª‰ΩúÊàêÂõûÊï∞„ÅÆÈõÜË®à
        const analyses = history.filter(item => item.type === 'analysis').length;
        const compositions = history.filter(item => item.type === 'composition').length;
        
        document.getElementById('total-analyses').textContent = analyses;
        document.getElementById('total-compositions').textContent = compositions;
        document.getElementById('history-count').textContent = history.length;
    });
}

/**
 * Êé•Á∂ö„ÉÜ„Çπ„Éà
 */
function testConnection() {
    const settings = getCurrentSettings();
    const testResult = document.getElementById('test-result');
    const testButton = document.getElementById('test-connection');
    
    if (!settings.apiKey) {
        showTestResult('API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
        return;
    }
    
    if (settings.provider === 'azure' && !settings.azureEndpoint) {
        showTestResult('Azure„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
        return;
    }
    
    testButton.disabled = true;
    testButton.textContent = 'üîÑ „ÉÜ„Çπ„Éà‰∏≠...';
    testResult.style.display = 'none';
    
    // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„Çπ„ÇØ„É™„Éó„Éà„Å´Êé•Á∂ö„ÉÜ„Çπ„Éà„Çí‰æùÈ†º
    chrome.runtime.sendMessage({
        action: 'testApiConnection',
        data: settings
    }, (response) => {
        testButton.disabled = false;
        testButton.textContent = 'üîß Êé•Á∂ö„ÉÜ„Çπ„Éà';
        
        if (response.success) {
            showTestResult('‚úÖ Êé•Á∂ö„ÉÜ„Çπ„Éà„ÅåÊàêÂäü„Åó„Åæ„Åó„Åü', 'success');
        } else {
            showTestResult(`‚ùå Êé•Á∂ö„ÉÜ„Çπ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${response.error}`, 'error');
        }
    });
}

/**
 * „ÉÜ„Çπ„ÉàÁµêÊûúË°®Á§∫
 */
function showTestResult(message, type) {
    const testResult = document.getElementById('test-result');
    testResult.textContent = message;
    testResult.className = `test-result ${type}`;
    testResult.style.display = 'block';
    
    // 5ÁßíÂæå„Å´Ëá™Âãï„ÅßÈùûË°®Á§∫
    setTimeout(() => {
        testResult.style.display = 'none';
    }, 5000);
}

/**
 * ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíÂèñÂæó
 */
function getCurrentSettings() {
    return {
        provider: document.getElementById('provider').value,
        model: document.getElementById('model').value,
        apiKey: document.getElementById('api-key').value,
        azureEndpoint: document.getElementById('azure-endpoint').value,
        autoDetect: document.getElementById('auto-detect').checked,
        showNotifications: document.getElementById('show-notifications').checked,
        saveHistory: document.getElementById('save-history').checked
    };
}

/**
 * Ë®≠ÂÆö„Çí‰øùÂ≠ò
 */
function saveSettings() {
    const settings = getCurrentSettings();
    
    // ÂøÖÈ†àÈ†ÖÁõÆ„ÅÆÊ§úË®º
    if (!settings.apiKey) {
        showNotification('API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
        return;
    }
    
    if (settings.provider === 'azure' && !settings.azureEndpoint) {
        showNotification('Azure„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
        return;
    }
    
    // ‰øùÂ≠òÂÆüË°å
    chrome.storage.local.set({ 'pta_settings': settings }, () => {
        showNotification('‚úÖ Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
    });
}

/**
 * Ë®≠ÂÆö„Çí„É™„Çª„ÉÉ„Éà
 */
function resetSettings() {
    showConfirmDialog('Ë®≠ÂÆö„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü', () => {
        const defaultSettings = {
            provider: 'azure',
            model: 'gpt-4',
            apiKey: '',
            azureEndpoint: '',
            autoDetect: true,
            showNotifications: true,
            saveHistory: true
        };
        
        chrome.storage.local.set({ 'pta_settings': defaultSettings }, () => {
            loadSettings();
            showNotification('Ë®≠ÂÆö„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü', 'info');
        });
    });
}

/**
 * Ë®≠ÂÆö„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà
 */
function exportSettings() {
    chrome.storage.local.get(['pta_settings'], (result) => {
        const settings = result.pta_settings || {};
        
        // API„Ç≠„Éº„ÇíÈô§Â§ñ
        const exportData = { ...settings };
        delete exportData.apiKey;
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], {
            type: 'application/json'
        });
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pta-settings.json';
        a.click();
        
        URL.revokeObjectURL(url);
        showNotification('Ë®≠ÂÆö„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü', 'success');
    });
}

/**
 * Ë®≠ÂÆö„Çí„Ç§„É≥„Éù„Éº„Éà
 */
function importSettings() {
    document.getElementById('import-file').click();
}

/**
 * „Ç§„É≥„Éù„Éº„Éà„Éï„Ç°„Ç§„É´Âá¶ÁêÜ
 */
function handleImportFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedSettings = JSON.parse(e.target.result);
            
            // ÁèæÂú®„ÅÆË®≠ÂÆö„Å®„Éû„Éº„Ç∏ÔºàAPI„Ç≠„Éº„ÅØ‰øùÊåÅÔºâ
            chrome.storage.local.get(['pta_settings'], (result) => {
                const currentSettings = result.pta_settings || {};
                const mergedSettings = {
                    ...importedSettings,
                    apiKey: currentSettings.apiKey // API„Ç≠„Éº„ÅØ‰øùÊåÅ
                };
                
                chrome.storage.local.set({ 'pta_settings': mergedSettings }, () => {
                    loadSettings();
                    showNotification('Ë®≠ÂÆö„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü', 'success');
                });
            });
            
        } catch (error) {
            showNotification('Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
        }
    };
    
    reader.readAsText(file);
    
    // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
    event.target.value = '';
}

/**
 * Â±•Ê≠¥„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà
 */
function exportHistory() {
    chrome.storage.local.get(['pta_history'], (result) => {
        const history = result.pta_history || [];
        
        if (history.length === 0) {
            showNotification('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„ÇãÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'info');
            return;
        }
        
        const blob = new Blob([JSON.stringify(history, null, 2)], {
            type: 'application/json'
        });
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pta-history.json';
        a.click();
        
        URL.revokeObjectURL(url);
        showNotification('Â±•Ê≠¥„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü', 'success');
    });
}

/**
 * ÂÖ®„Éá„Éº„Çø„ÇíÂâäÈô§
 */
function clearAllData() {
    showConfirmDialog('„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„ÇøÔºàË®≠ÂÆö„ÉªÂ±•Ê≠¥Ôºâ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ', () => {
        chrome.storage.local.clear(() => {
            loadSettings();
            loadStatistics();
            showNotification('„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'info');
        });
    });
}

/**
 * Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞Ë°®Á§∫
 */
function showConfirmDialog(message, callback) {
    const modal = document.getElementById('confirm-modal');
    const messageElement = document.getElementById('confirm-message');
    const okButton = document.getElementById('confirm-ok');
    
    messageElement.textContent = message;
    modal.style.display = 'flex';
    
    // Êó¢Â≠ò„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂâäÈô§
    okButton.replaceWith(okButton.cloneNode(true));
    const newOkButton = document.getElementById('confirm-ok');
    
    newOkButton.addEventListener('click', () => {
        closeConfirmModal();
        callback();
    });
}

/**
 * Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈñâ„Åò„Çã
 */
function closeConfirmModal() {
    document.getElementById('confirm-modal').style.display = 'none';
}

/**
 * ÈÄöÁü•Ë°®Á§∫
 */
function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';
    
    // 3ÁßíÂæå„Å´Ëá™Âãï„ÅßÈùûË°®Á§∫
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

/**
 * „Éë„Çπ„ÉØ„Éº„ÉâË°®Á§∫Âàá„ÇäÊõø„Åà
 */
function togglePassword() {
    const apiKeyInput = document.getElementById('api-key');
    const toggleButton = document.querySelector('.toggle-password');
    
    if (apiKeyInput.type === 'password') {
        apiKeyInput.type = 'text';
        toggleButton.textContent = 'üôà';
    } else {
        apiKeyInput.type = 'password';
        toggleButton.textContent = 'üëÅÔ∏è';
    }
}

// „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÖ¨Èñã
window.closeConfirmModal = closeConfirmModal;
window.togglePassword = togglePassword;