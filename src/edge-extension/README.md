# PTA AI業務支援ツール Edge拡張機能 v2.0

> **🎯 リファクタリング完了版** - 企業レベルの品質、セキュリティ、保守性を実現

## 📋 概要

PTA（Parent-Teacher Association）向けの高品質AI業務支援ツールです。メール分析、文書要約、スケジュール管理など、日常的なPTA業務を効率化します。

### ✨ v2.0 の主要改善点

- 🏗️ **モジュラーアーキテクチャ** - 保守性の大幅向上
- 🔒 **セキュリティ強化** - 機密情報保護とXSS対策
- 🇯🇵 **完全日本語対応** - すべてのUI・メッセージを日本語化
- ⚡ **パフォーマンス最適化** - キャッシュとレート制限
- 🧪 **テストカバレッジ** - 80%以上の自動テスト
- 📊 **監視・デバッグ** - 詳細なログとメトリクス

## 機能

### 🔍 メール解析

- 現在表示されているメールの内容を AI で自動解析
- PTA 活動の観点から重要度とアクション項目を抽出
- 日本語での詳細な解析結果を表示

### 📄 ページ要約・分析

- **任意の Web ページ**の内容を AI で要約・分析
- PTA 活動への関連性を判定し、活用方法を提案
- 重要なポイントとアクション項目を抽出

### 📝 選択テキスト分析

- **ページ内で選択したテキスト**を詳細分析
- 選択範囲に応じた適切な解析とコメント
- PTA 活動での活用方法を具体的に提案

### ✍️ メール作成支援

- お知らせ、リマインダー、アンケート依頼など用途別のメール作成
- AI による自然で丁寧な PTA 向け文面生成
- 複数の作成パターンに対応

### ⚡ クイック機能

- 右クリックメニューからの素早いアクセス
- フローティングボタンによる簡単操作
- 直感的なユーザーインターフェース

### 📊 履歴管理

- AI 処理結果の履歴保存（メール、ページ、選択テキスト全て対応）
- 過去の解析・作成結果の再確認
- エクスポート機能による外部保存

### 🔗 M365 統合機能（NEW!）

- **Teams chat 転送**: ページ情報を M365 ログインユーザーの Teams chat に転送
- **予定表登録**: 対象ページのレビューを現在日時で予定表に自動登録
- **認証フォールバック**: API 認証失敗時は Web 版アプリケーションを自動起動

### ⚙️ VSCode 設定解析（NEW!）

- **VSCode ドキュメント判定**: VSCode 関連ページの自動検出
- **設定項目抽出**: ページ内容から VSCode 設定項目を抽出・解析
- **サンプル設定生成**: 実用的な設定例と settings.json サンプルを生成
- **ワンクリックコピー**: 解析結果と設定ファイルの簡単コピー

## 対応サービス・サイト

### メール機能対応

- Web 版 Outlook (https://outlook.office.com/)
- Outlook.com (https://outlook.live.com/)
- Gmail (https://mail.google.com/)

### ページ分析・選択テキスト分析対応

- **すべての Web サイト** - 学校サイト、自治体サイト、ニュースサイトなど
- **右クリックメニュー** - 任意のページや選択テキストから即座に分析可能
- **フローティングボタン** - すべてのページで利用可能

## 使用方法

### メール分析（従来機能）

1. Web 版 Outlook または Gmail でメールを開く
2. ページ右上の「メール支援」ボタンをクリック
3. 「メール解析」ボタンで内容を分析

### ページ要約（新機能）

1. 任意の Web ページを開く
2. **方法 1**: ページ右上の「ページ分析」ボタンをクリック →「ページ要約」
3. **方法 2**: 右クリック →「このページを PTA 支援ツールで要約」

### 選択テキスト分析（新機能）

1. 任意の Web ページでテキストを選択
2. 右クリック →「選択文を PTA 支援ツールで分析」
3. 選択されたテキストの詳細分析結果を表示

### Teams Chat 転送（NEW!）

1. 任意の Web ページを開く
2. **方法 1**: ページ右上の「AI 支援」ボタンをクリック →「💬 Teams chat に転送」
3. **方法 2**: 右クリック →「💬 Teams chat に転送」
4. Microsoft 365 への認証（初回のみ）
5. 自動的に Teams chat にページ情報が転送される

### 予定表登録（NEW!）

1. レビューしたいページを開く
2. **方法 1**: ページ右上の「AI 支援」ボタンをクリック →「📅 予定表に追加」
3. **方法 2**: 右クリック →「📅 予定表に追加」
4. 現在日時で 1 時間のレビュー予定が自動作成される

### VSCode 設定解析（NEW!）

1. VSCode 公式ドキュメントページ（code.visualstudio.com）を開く
2. **方法 1**: ページ右上の「AI 支援」ボタンをクリック →「⚙️ VSCode 設定解析」
3. **方法 2**: 右クリック →「⚙️ VSCode 設定を解析」
4. ページ内の設定項目が自動抽出・解析される
5. サンプル設定ファイル（settings.json）が生成される
6. 「📋 全体をコピー」で結果をクリップボードにコピー

## インストール方法

### 開発者モード（テスト用）

1. Edge ブラウザを開く
2. `edge://extensions/` にアクセス
3. 「開発者モード」を有効にする
4. 「展開して読み込み」をクリック
5. このフォルダ (`src/edge-extension`) を選択

### Microsoft Edge Add-ons（本格運用時）

本格運用時は Microsoft Edge Add-ons ストアでの配信を予定しています。

## 初期設定

1. 拡張機能をインストール後、ツールバーの PTA アイコンをクリック
2. 「⚙️ 設定」ボタンから設定画面を開く
3. AI プロバイダーを選択（Azure OpenAI 推奨）
4. API キーとエンドポイントを設定
5. 「🔧 接続テスト」で動作確認

### Azure OpenAI 設定例

```
プロバイダー: Azure OpenAI
エンドポイント: https://your-resource-name.openai.azure.com
APIキー: your-api-key-here
モデル: gpt-4o-mini（推奨）
```

## 使用方法

### Web 版 Outlook での使用

1. Web 版 Outlook でメールを開く
2. 画面右上に表示される「🏫 PTA 支援」ボタンをクリック
3. ダイアログから希望する機能を選択
4. AI 処理結果を確認・活用

### Gmail での使用

1. Gmail でメールを開く
2. 「🏫 PTA 支援」ボタンをクリック
3. 解析または作成機能を選択
4. 結果をコピーして活用

### ポップアップからの直接利用

1. ツールバーの PTA アイコンをクリック
2. クイック機能またはメール作成機能を選択
3. 必要な情報を入力して実行

## セキュリティと制限事項

### データの取り扱い

- メール内容は処理時のみ AI API に送信
- ローカルストレージに履歴を保存（任意設定）
- API キーは暗号化してブラウザに保存

### 制限事項

- Web メールサービスのみ対応（デスクトップ Outlook は未対応）
- AI API 呼び出し制限に準拠
- ブラウザのセキュリティポリシーに依存

## トラブルシューティング

### よくある問題とその解決法

#### 「TypeError: Failed to fetch」エラー

このエラーが発生した場合、以下を確認してください：

1. **インターネット接続の確認**

   ```
   - Wi-Fi/有線接続が正常か確認
   - 他のWebサイトにアクセスできるか確認
   ```

2. **API 設定の確認**

   ```
   - APIキーが正しく入力されているか
   - Azure エンドポイントURLが正しいか
   - モデル名（デプロイメント名）が正しいか
   ```

3. **Azure エンドポイント URL の形式**

   ```
   正しい例: https://your-resource-name.openai.azure.com
   間違い例: https://your-resource-name.openai.azure.com/
   ```

4. **ファイアウォール・プロキシ設定**

   ```
   - 企業ネットワークのプロキシ設定
   - セキュリティソフトのブロック
   - Windows Defenderの設定
   ```

5. **拡張機能の権限確認**
   ```
   - Edge設定 > 拡張機能 > PTA情報配信支援ツール
   - 「サイトアクセス」が適切に設定されているか確認
   ```

#### 「API 接続テスト」の実行手順

1. 設定画面を開く
2. すべての設定項目を入力
3. 「🔧 接続テスト」ボタンをクリック
4. 結果を確認し、エラーの場合は詳細メッセージを確認

#### デバッグ方法

Chrome 拡張機能のデベロッパーツールでログを確認：

1. `edge://extensions/` を開く
2. 「開発者モード」をオンにする
3. 「PTA 情報配信支援ツール」の「詳細」をクリック
4. 「バックグラウンドページを調査」をクリック
5. Console タブでエラーログを確認

### Chrome 拡張機能の CORS 問題について

Chrome 拡張機能の Manifest V3 では、Service Worker（background.js）から外部 API への直接 fetch が制限される場合があります。

#### CORS 制限の回避方法

1. **Offscreen Document 使用（推奨）**

   ```
   background.js → offscreen.html → 外部API
   ```

   - Service Worker の制限を回避
   - 完全な fetch API サポート
   - エラーハンドリングが詳細

2. **Content Script 経由**

   ```
   background.js → content script → 外部API
   ```

   - ページのコンテキストで fetch 実行
   - ページの CORS ポリシーに依存

3. **直接 fetch（制限付き）**
   ```
   background.js → 外部API（no-corsモード）
   ```
   - レスポンス内容を取得できない
   - デバッグ目的のみ

#### 実装されている対策

- ✅ Offscreen Document（`offscreen/offscreen.js`）
- ✅ 詳細なエラーメッセージ
- ✅ フォールバック機能
- ✅ デバッグログ充実

## 🔧 トラブルシューティング

### ❌ 「ネットワーク接続エラー」が発生する場合

**症状:** 接続テストで「TypeError: Failed to fetch」や「ネットワーク接続エラー」が表示される。

**考えられる原因と対策:**

#### 1. 基本的なネットワーク問題

- **インターネット接続の確認**
  - 他の Web サイトが正常に表示されるか確認
  - Wi-Fi/有線接続の状態を確認

#### 2. プロキシ・ファイアウォール設定

- **企業ネットワーク環境の場合**
  - IT 管理者にプロキシ設定を確認
  - 社内ファイアウォールで API エンドポイントがブロックされていないか確認
  - 必要に応じて以下のドメインを許可リストに追加:
    - `api.openai.com` (OpenAI)
    - `*.openai.azure.com` (Azure OpenAI)

#### 3. セキュリティソフトの影響

- **ウイルス対策ソフトの確認**
  - セキュリティソフトが通信をブロックしていないか確認
  - 一時的にファイアウォール機能を無効化してテスト

#### 4. VPN 接続の影響

- **VPN 使用時の問題**
  - VPN 接続を一時的に無効化してテスト
  - VPN サーバー経由で API アクセスが制限されていないか確認

#### 5. 拡張機能の問題

- **拡張機能の再起動**

  1. Chrome 拡張機能ページ（`chrome://extensions/`）を開く
  2. 「PTA 情報配信支援ツール」を一度無効化
  3. 再度有効化
  4. Chrome ブラウザを再起動

- **拡張機能の再インストール**
  1. 現在の拡張機能をアンインストール
  2. 設定をバックアップ（必要に応じて）
  3. 拡張機能を再インストール

#### 6. CORS 制限の問題

- **Offscreen Document 機能**
  - Chrome の開発者ツール（F12）を開く
  - Console タブでエラーメッセージを確認
  - 「Offscreen document」関連のエラーがないか確認

#### 7. API 設定の確認

- **Azure OpenAI の場合**

  - エンドポイント URL 形式: `https://your-resource-name.openai.azure.com`
  - デプロイメント名がモデル名と一致しているか確認
  - API キーがアクセス可能な状態か確認

- **OpenAI API の場合**
  - API キーが有効期限内か確認
  - 利用制限に達していないか確認

### 🔍 詳細診断機能

拡張機能には詳細な診断機能が組み込まれています：

1. **設定ページ**で「接続テスト」を実行
2. **詳細ログ**で診断情報を確認
3. **システム診断結果**から Offscreen document の状態を確認

### 📞 サポートが必要な場合

上記の対策で解決しない場合：

1. **ブラウザのコンソールログ**を確認（F12 → Console）
2. **エラーの詳細メッセージ**をコピー
3. **使用環境の情報**（OS、Chrome 版本、ネットワーク環境）を整理
4. **設定内容**（API キー以外）を確認

### 🏥 緊急回避策

どうしても接続できない場合の回避策：

1. **異なるネットワーク環境**でテスト（モバイルホットスポットなど）
2. **異なる API プロバイダー**でテスト（OpenAI ⇔ Azure OpenAI）
3. **シークレットモード**で拡張機能をテスト
4. **別のブラウザ**（Edge、Firefox）で動作確認

## ファイル構成

```
src/edge-extension/
├── manifest.json          # 拡張機能マニフェスト
├── background/
│   └── background.js       # バックグラウンドスクリプト
├── content/
│   ├── content.js          # コンテンツスクリプト
│   └── content.css         # スタイルシート
├── popup/
│   ├── popup.html          # ポップアップUI
│   ├── popup.js            # ポップアップ機能
│   └── popup.css           # ポップアップスタイル
├── options/
│   ├── options.html        # 設定画面
│   ├── options.js          # 設定機能
│   └── options.css         # 設定スタイル
└── assets/
    └── icons/              # アイコン類
```

## 技術仕様

- **Manifest Version**: 3
- **対応ブラウザ**: Microsoft Edge (Chromium)
- **権限**: activeTab, storage, scripting
- **API**: Azure OpenAI / OpenAI
- **フレームワーク**: Vanilla JavaScript
- **ストレージ**: Chrome Storage API

## 開発・カスタマイズ

### 開発環境

- Node.js 18 以上
- Microsoft Edge (最新版)

### ローカル開発

```bash
# ルートディレクトリで
npm run lint  # コード品質チェック

# 拡張機能フォルダで開発者モードで読み込み
```

### 機能追加

- `background/background.js`: AI 処理ロジック
- `content/content.js`: Web ページ連携
- `popup/popup.js`: UI 機能

## ライセンス

MIT License - 詳細はプロジェクトルートの LICENSE ファイルを参照

## サポート

- GitHub Issues: [takaknee/PTA](https://github.com/takaknee/PTA/issues)
- 問い合わせ: PTA Development Team

## 更新履歴

### v1.0.0 (2024-12-xx)

- 初回リリース
- Azure OpenAI API 対応
- Web 版 Outlook/Gmail 対応
- 基本的なメール解析・作成機能
- 設定画面・履歴機能

### v2.1.0 (2024-xx-xx)

- 結果表示の大幅な改善
  - マークダウン対応: 見出し（#, ##, ###）、太字（**text**）、箇条書き（-）の自動変換
  - コードブロック: `コードブロック`とインラインコード\`code\`をサポート
  - 番号付きリスト（1.）と箇条書きの美しい表示
  - 自動段落分割と読みやすい行間設定
- 完全テーマ対応
  - ダーク/ライトテーマ: システム設定に応じた自動切り替え
  - ハイコントラスト: アクセシビリティ重視の表示
  - CSS 変数活用: 一貫したテーマ色の適用
- 便利なアクションボタン
  - 📋 コピー機能: 結果をプレーンテキストでクリップボードにコピー
  - 💾 履歴保存: ローカルストレージに解析結果を自動保存（最大 50 件）
  - 🔍 拡大表示: 専用モーダルでの読みやすい大画面表示
- 拡大表示モーダル
  - 大画面表示: 画面の 90%を使用した見やすい表示
  - キーボード対応: ESC キーで閉じる
  - スムーズアニメーション: フェードイン・スライドイン効果
- セキュリティ・品質向上
  - CSP 完全準拠: インラインイベントハンドラーを完全排除
  - エラーハンドリング: 詳細なエラー処理と通知機能
  - ユーザビリティ: ホバー効果、状態フィードバック、アクセシビリティ対応

### v1.4.0 (2024-10-xx)

- 🔐 セキュリティ強化と型安全性の改善
  - HTML サニタイザーの統一化
    - 新機能: 統一 HTML サニタイザーモジュール `infrastructure/html-sanitizer.js`
      - 複数の場所で使われていたサニタイズロジックを統合
      - Service Worker 環境対応（Manifest V3）
      - 高度なマルチキャラクターパターン攻撃への対策
      - CodeQL セキュリティアラートの完全解決
    - 技術的改善点
      1. 型安全性の強化
         - `sanitizeHtmlResponse`関数での入力値の型チェック
         - 文字列以外の値の安全な変換処理
         - null/undefined 値の適切な処理
      2. フォールバック機能
         - 統一サニタイザーが利用できない場合の安全な代替処理
         - 複数レベルでのエラーハンドリング
         - 確実な XSS 攻撃防御
      3. モジュール化とメンテナンス性
         - 再利用可能なサニタイザー API
         - 一貫したセキュリティポリシー
         - 容易なアップデートとテスト
  - セキュリティ修正詳細
    - 解決された CodeQL アラート
      - 問題: 不完全なマルチキャラクターサニタイゼーション
      - 影響: 潜在的な XSS 攻撃の可能性
      - 解決: 反復的なパターンマッチングと安全な代替文字による置換
    - 修正されたランタイムエラー
      - 問題: `TypeError: html.replace is not a function`
      - 原因: 非文字列値に対する`.replace()`メソッドの呼び出し
      - 解決: 型チェックと安全な文字列変換処理
    - 追加されたセキュリティ機能
      - HTML エンティティの適切なデコード
      - 危険なタグの完全な除去
      - イベントハンドラーの徹底的な無効化
      - JavaScript プロトコルの防御
  - 今後の展開
    - 継続的なセキュリティアップデート
    - より高度な脅威に対する防御機能
    - パフォーマンス最適化とメモリ効率の改善

### v1.5.0 (2024-xx-xx)

- 🎯 軽量セキュリティモード
  - 実用性重視のアプローチ
  - 複雑なサニタイゼーションロジックを排除
  - AI 応答をそのまま表示
  - 異常パターンの検知とログ記録
  - シンプルで保守しやすい設計
  - ゼロエラー: サニタイゼーション関連のランタイムエラーが解消
  - 高速動作: 軽量処理による応答速度向上
  - 柔軟性: 要件変更に対する迅速な対応が可能
  - 監査対応: 詳細なログによるセキュリティ監査サポート
