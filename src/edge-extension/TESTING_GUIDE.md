# AI 業務支援ツール Edge 拡張機能 - テスト手順

## テスト環境

- **対象**: Chrome/Edge 拡張機能（AI 業務支援ツール）
- **新機能**: M365統合機能、VSCode設定解析機能
- **テスト日**: 2025-01-22
- **バージョン**: v1.1.0

## 事前準備

1. **拡張機能の読み込み**:

   ```
   Chrome/Edge → 拡張機能 → デベロッパーモード → 「パッケージ化されていない拡張機能を読み込む」
   → src/edge-extension フォルダを選択
   ```

2. **開発者ツールの準備**:
   - F12 でデベロッパーツールを開く
   - Console タブを表示
   - エラーメッセージとデバッグログを監視

3. **テスト用アカウント**:
   - Microsoft 365アカウント（Teams/Outlook Web版テスト用）
   - Azure OpenAI APIキー（設定画面で設定）

## テストケース

### 1. 基本機能テスト（テストページ）

**手順**:

1. `test-page.html`をブラウザで開く
2. 右上の「AI 支援」ボタンをクリック
3. ダイアログで「このページを要約」をクリック

**期待される結果**:

- ✅ AI 支援ボタンが表示される
- ✅ ダイアログが正常に表示される
- ✅ 新機能ボタンが表示される（Teams転送、予定表追加）
- ✅ コンソールに「✅ pageContent が正常に設定されています」と表示
- ✅ 「undefined」エラーが発生しない
- ✅ ページ解析が正常に実行される

### 2. M365統合機能テスト

#### 2.1 Teams Chat転送テスト

**手順**:
1. 任意のWebページを開く
2. 「AI支援」ボタン → 「💬 Teams chatに転送」をクリック
3. Microsoft 365認証を実行（初回のみ）

**期待される結果**:
- ✅ Microsoft認証ダイアログが表示される
- ✅ 認証成功時：「Teams chatに転送しました」メッセージ表示
- ✅ 認証失敗時：Teams Web版が自動で開く

#### 2.2 予定表登録テスト

**手順**:
1. 任意のWebページを開く
2. 「AI支援」ボタン → 「📅 予定表に追加」をクリック

**期待される結果**:
- ✅ 現在日時でのイベント作成成功メッセージ表示
- ✅ 認証失敗時：Outlook Web版が自動で開く
- ✅ イベント詳細にページ情報が含まれる

### 3. VSCode設定解析機能テスト

#### 3.1 VSCodeドキュメントページでのテスト

**手順**:
1. `https://code.visualstudio.com/docs/editor/settings-sync` を開く
2. 「AI支援」ボタン → 「⚙️ VSCode設定解析」をクリック

**期待される結果**:
- ✅ AI解析処理の実行
- ✅ 設定項目一覧の表示
- ✅ サンプルsettings.jsonの生成
- ✅ 「📋 全体をコピー」ボタンの動作

#### 3.2 一般ページでのエラーハンドリングテスト

**手順**:
1. 一般的なWebページ（例：google.com）を開く
2. 「AI支援」ボタンをクリック
3. VSCode設定解析ボタンの有無を確認

**期待される結果**:
- ✅ VSCode設定解析ボタンが表示されない
- ✅ 右クリック → VSCode設定解析を選択時、適切なエラーメッセージ表示

### 4. コンテキストメニューテスト

**手順**:
1. 任意のWebページで右クリック
2. 新しいメニュー項目を確認

**期待される結果**:
- ✅ 💬 Teams chatに転送
- ✅ 📅 予定表に追加
- ✅ ⚙️ VSCode設定を解析
- ✅ 各項目クリックで対応する機能が動作

**確認ポイント**:

```javascript
// コンソールで確認すべきメッセージ
"Teams転送ボタンのイベントリスナー設定完了";
"予定表追加ボタンのイベントリスナー設定完了";
"VSCode設定解析ボタンのイベントリスナー設定完了";
"✅ data.pageContent が正常: ...";
```

### 2. 実際の Web サイトテスト

**テスト対象サイト**:

- Qiita 記事ページ
- SharePoint ページ
- 一般的なニュースサイト
- GitHub repository

**手順**:

1. 各サイトにアクセス
2. AI 支援ボタンをクリック
3. 「このページを要約」をクリック
4. コンソールログを確認

**期待される結果（各サイト共通）**:

- ✅ コンテンツ抽出が成功
- ✅ `pageContent`が適切に設定される
- ✅ AI API が正常に呼び出される
- ❌ 「undefined」や空文字列エラーが発生しない

### 3. 選択テキスト解析テスト

**手順**:

1. 任意の Web ページでテキストを選択
2. AI 支援ダイアログで「選択文を解析」をクリック

**期待される結果**:

- ✅ 選択されたテキストが正常に解析される
- ✅ 結果が適切に表示される

### 4. CSP 制限サイトテスト

**テスト対象**:

- SharePoint Online
- Office 365 サイト
- 厳格な CSP を持つ企業サイト

**確認ポイント**:

- ✅ インラインイベントハンドラーエラーが発生しない
- ✅ すべての UI ボタンが正常に動作する
- ✅ パスワード表示/非表示トグルが動作する

## デバッグ情報の見方

### 正常なログの例

```javascript
// コンテンツ抽出成功
"コンテンツ抽出成功: main";
"最終的に抽出されたコンテンツ（最初の200文字）: PTA（Parent-Teacher Association）は、保護者と教師の会という意味で...";

// ページ解析成功
"🔍 handleAnalyzePage開始: {pageTitle: '...', pageUrl: '...', pageContent: '...'}";
"✅ data.pageContent が正常: ...";
```

### 問題のあるログの例

```javascript
// 修正前に発生していたエラー
"⚠️ pageContent が未定義です!";
"⚠️ pageContent が文字列の 'undefined' です!";
"❌ data.pageContent が空文字列です!";
```

## トラブルシューティング

### 問題: AI 支援ボタンが表示されない

**原因と対策**:

- コンテンツスクリプトの読み込み確認
- 拡張機能の権限設定確認（activeTab）
- ページの初期化完了を待機

### 問題: ページコンテンツが空になる

**原因と対策**:

- サイト固有のセレクタを追加
- `extractPageContent()`関数のフォールバック処理確認
- CSP によるスクリプト実行制限の確認

### 問題: AI API 呼び出しエラー

**原因と対策**:

- 設定画面で API キーが正しく設定されているか確認
- ネットワーク接続の確認
- API 利用制限の確認

## 修正版の改善点

1. **堅牢なコンテンツ抽出**:

   - 複数のフォールバック戦略
   - サイト固有のセレクタ対応
   - エラー処理の強化

2. **詳細なデバッグ情報**:

   - 各段階でのログ出力
   - エラーケースの詳細診断
   - 開発者向けの詳細情報

3. **完全な CSP 準拠**:
   - インラインイベントハンドラーの完全排除
   - セキュアなイベント管理
   - 企業環境での安全な動作

## 次回のテスト時の注意点

- 新しいサイトでテストする際は、コンソールログを必ず確認
- 「undefined」エラーが発生した場合は、サイト固有のセレクタを追加
- CSP 制限の厳しいサイトでは、すべての UI 要素が動作することを確認
