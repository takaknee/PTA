# PTA Edge 拡張機能 - 修正版テスト手順

## テスト環境

- **対象**: Chrome/Edge 拡張機能（PTA 情報配信システム）
- **修正内容**: ページコンテンツ「undefined」問題の修正
- **テスト日**: 2025-01-22

## 事前準備

1. **拡張機能の読み込み**:

   ```
   Chrome/Edge → 拡張機能 → デベロッパーモード → 「パッケージ化されていない拡張機能を読み込む」
   → src/edge-extension フォルダを選択
   ```

2. **開発者ツールの準備**:
   - F12 でデベロッパーツールを開く
   - Console タブを表示
   - エラーメッセージとデバッグログを監視

## テストケース

### 1. 基本機能テスト（テストページ）

**手順**:

1. `test-page.html`をブラウザで開く
2. 右上の「AI 支援」ボタンをクリック
3. ダイアログで「このページを要約」をクリック

**期待される結果**:

- ✅ AI 支援ボタンが表示される
- ✅ ダイアログが正常に表示される
- ✅ コンソールに「✅ pageContent が正常に設定されています」と表示
- ✅ 「undefined」エラーが発生しない
- ✅ ページ解析が正常に実行される

**確認ポイント**:

```javascript
// コンソールで確認すべきメッセージ
"🧪 PTA Edge拡張機能テストページが読み込まれました";
"✅ メインコンテンツが検出されました";
"最終的に抽出されたコンテンツ（最初の200文字）: ...";
"✅ data.pageContent が正常: ...";
```

### 2. 実際の Web サイトテスト

**テスト対象サイト**:

- Qiita 記事ページ
- SharePoint ページ
- 一般的なニュースサイト
- GitHub repository

**手順**:

1. 各サイトにアクセス
2. AI 支援ボタンをクリック
3. 「このページを要約」をクリック
4. コンソールログを確認

**期待される結果（各サイト共通）**:

- ✅ コンテンツ抽出が成功
- ✅ `pageContent`が適切に設定される
- ✅ AI API が正常に呼び出される
- ❌ 「undefined」や空文字列エラーが発生しない

### 3. 選択テキスト解析テスト

**手順**:

1. 任意の Web ページでテキストを選択
2. AI 支援ダイアログで「選択文を解析」をクリック

**期待される結果**:

- ✅ 選択されたテキストが正常に解析される
- ✅ 結果が適切に表示される

### 4. CSP 制限サイトテスト

**テスト対象**:

- SharePoint Online
- Office 365 サイト
- 厳格な CSP を持つ企業サイト

**確認ポイント**:

- ✅ インラインイベントハンドラーエラーが発生しない
- ✅ すべての UI ボタンが正常に動作する
- ✅ パスワード表示/非表示トグルが動作する

## デバッグ情報の見方

### 正常なログの例

```javascript
// コンテンツ抽出成功
"コンテンツ抽出成功: main";
"最終的に抽出されたコンテンツ（最初の200文字）: PTA（Parent-Teacher Association）は、保護者と教師の会という意味で...";

// ページ解析成功
"🔍 handleAnalyzePage開始: {pageTitle: '...', pageUrl: '...', pageContent: '...'}";
"✅ data.pageContent が正常: ...";
```

### 問題のあるログの例

```javascript
// 修正前に発生していたエラー
"⚠️ pageContent が未定義です!";
"⚠️ pageContent が文字列の 'undefined' です!";
"❌ data.pageContent が空文字列です!";
```

## トラブルシューティング

### 問題: AI 支援ボタンが表示されない

**原因と対策**:

- コンテンツスクリプトの読み込み確認
- 拡張機能の権限設定確認（activeTab）
- ページの初期化完了を待機

### 問題: ページコンテンツが空になる

**原因と対策**:

- サイト固有のセレクタを追加
- `extractPageContent()`関数のフォールバック処理確認
- CSP によるスクリプト実行制限の確認

### 問題: AI API 呼び出しエラー

**原因と対策**:

- 設定画面で API キーが正しく設定されているか確認
- ネットワーク接続の確認
- API 利用制限の確認

## 修正版の改善点

1. **堅牢なコンテンツ抽出**:

   - 複数のフォールバック戦略
   - サイト固有のセレクタ対応
   - エラー処理の強化

2. **詳細なデバッグ情報**:

   - 各段階でのログ出力
   - エラーケースの詳細診断
   - 開発者向けの詳細情報

3. **完全な CSP 準拠**:
   - インラインイベントハンドラーの完全排除
   - セキュアなイベント管理
   - 企業環境での安全な動作

## 次回のテスト時の注意点

- 新しいサイトでテストする際は、コンソールログを必ず確認
- 「undefined」エラーが発生した場合は、サイト固有のセレクタを追加
- CSP 制限の厳しいサイトでは、すべての UI 要素が動作することを確認
