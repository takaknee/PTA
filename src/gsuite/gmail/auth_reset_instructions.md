# Google Apps Script 認可権限の再設定方法

Google Apps Scriptの認可権限が不足している場合や、再設定が必要な場合は、以下の手順で操作してください。

## 1. スクリプトエディタでの権限リセット

1. Google スプレッドシートを開く
2. メニューから「拡張機能」→「Apps Script」を選択
3. Apps Scriptエディタが開いたら、以下のいずれかを実行:
   - メニューから「実行」→「関数の実行」→「onOpen」を選択
   - または任意の機能（例: `deletePromotionEmails`）を選択して実行

4. 権限リクエストのダイアログが表示されたら「権限を確認」をクリック
5. 必要な権限をすべて許可

## 2. スクリプトの権限を手動でリセットする方法

既存の認証情報をクリアして、新しく権限を取得し直す場合:

1. Apps Scriptエディタで「編集」→「プロジェクトのプロパティ」を選択
2. 「スクリプトのプロパティ」タブを開く
3. トークンに関する項目があれば削除
4. ブラウザのキャッシュもクリアすると効果的です

## 3. Google アカウント側で権限を確認/再設定

1. [Google アカウントのセキュリティ設定](https://myaccount.google.com/security)にアクセス
2. 「アプリのパスワードとアクセス権」→「サードパーティアプリのアクセス権」を選択
3. 該当するスクリプトを見つけ、権限を確認または削除
4. スクリプトを再度実行すると、新しく権限リクエストが表示されます

## 4. スコープを明示的に宣言する

スクリプトの先頭に必要な権限スコープを明示的に宣言することで、必要な権限を明確にできます。以下に例を示します:

```javascript
/**
 * @OnlyCurrentDoc
 * Gmail整理スクリプト
 * 
 * 以下の権限が必要です:
 * - https://www.googleapis.com/auth/gmail.readonly
 * - https://www.googleapis.com/auth/gmail.modify
 * - https://www.googleapis.com/auth/spreadsheets.currentonly
 */
```

## 5. マニフェストファイルでスコープを設定

1. Apps Scriptエディタで「プロジェクト設定」アイコン（⚙️）をクリック
2. 「スクリプトのプロパティ」タブを選択
3. 「OAuth スコープ」セクションを確認し、必要に応じて編集
4. また「appsscript.json」ファイルを表示（メニューから「表示」→「プロジェクト マニフェスト」を選択）して直接編集することも可能

## 6. トリガーの再設定

自動実行用のトリガーを使用している場合は、トリガーも再設定が必要かもしれません:

1. Apps Scriptエディタで「トリガー」アイコン（⏰）をクリック
2. 既存のトリガーを削除
3. 新しくトリガーを作成し、権限を許可

## 注意事項

- 組織のGoogleアカウントを使用している場合、管理者によって一部の権限が制限されている可能性があります
- スクリプトが要求する権限が多すぎると、Googleによって「安全ではない」と判断される場合があります
- 必要最小限の権限スコープに制限することをお勧めします
