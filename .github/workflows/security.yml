name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è©³ç´°åˆ†æ

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ã®åˆå‰2æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: "0 17 * * 0"

jobs:
  secret-scan:
    name: é«˜åº¦ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è©³ç´°ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º
        run: |
          echo "=== é«˜åº¦ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆåˆ†æã‚’å®Ÿè¡Œä¸­ ==="

          # æ§˜ã€…ãªAPI ã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œç´¢
          echo "ğŸ” è©³ç´°ãªAPI ã‚­ãƒ¼ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³æ¤œç´¢..."

          # Google API ã‚­ãƒ¼
          if grep -r -E "AIza[0-9A-Za-z\\-_]{35}" --include="*.gs" --include="*.bas" --include="*.js" .; then
            echo "âŒ Google API ã‚­ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            exit 1
          fi

          # Azure/Microsoft ã‚­ãƒ¼
          if grep -r -E "[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}" --include="*.gs" --include="*.bas" --include="*.js" .; then
            echo "âš ï¸  Azure GUIDå½¢å¼ã®æ–‡å­—åˆ—ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          fi

          # OpenAI API ã‚­ãƒ¼
          if grep -r -E "sk-[a-zA-Z0-9]{48}" --include="*.gs" --include="*.bas" --include="*.js" .; then
            echo "âŒ OpenAI API ã‚­ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            exit 1
          fi

          # ä¸€èˆ¬çš„ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ–‡å­—åˆ—
          if grep -r -E "(password|pwd|pass).*=.*['\"][^'\"]{8,}['\"]" --include="*.gs" --include="*.bas" --include="*.js" . | grep -v "YOUR_PASSWORD_HERE" | grep -v "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"; then
            echo "âš ï¸  æ½œåœ¨çš„ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          fi

          echo "âœ… é«˜åº¦ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"

  permission-analysis:
    name: æ¨©é™ãƒ»ã‚¹ã‚³ãƒ¼ãƒ—åˆ†æ
    runs-on: ubuntu-latest

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Google Apps Script æ¨©é™åˆ†æ
        run: |
          echo "=== Google Apps Script æ¨©é™åˆ†æ ==="

          if [ -f "src/gsuite/pta/appsscript.json" ]; then
            echo "ğŸ“‹ OAuth ã‚¹ã‚³ãƒ¼ãƒ—ã®ç¢ºèª:"
            cat src/gsuite/pta/appsscript.json | grep -A 20 "oauthScopes" || true
            
            echo "ğŸ” å±é™ºãªæ¨©é™ã®æ¤œå‡º:"
            if grep -E "(auth/script\..*|auth/drive\..*file)" src/gsuite/pta/appsscript.json; then
              echo "âš ï¸  å¼·åŠ›ãªæ¨©é™ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚å¿…è¦æ€§ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            else
              echo "âœ… æ¨©é™ã¯é©åˆ‡ã«åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™"
            fi
          else
            echo "â„¹ï¸  appsscript.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
      - name: Excel VBA ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ
        run: |
          echo "=== Excel VBA ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ ==="

          if [ -d "src/excel" ] && [ "$(find src/excel -name '*.bas' | wc -l)" -gt 0 ]; then
            echo "ğŸ” å±é™ºãªVBAé–¢æ•°ã®æ¤œå‡º:"
            
            # ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
            if grep -r -E "Shell\s*\(" src/excel/*.bas; then
              echo "âš ï¸  Shellé–¢æ•°ã®ä½¿ç”¨ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            fi
            
            # ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹
            if grep -r -E "CreateObject.*WScript\.Shell" src/excel/*.bas; then
              echo "âš ï¸  WScript.Shellã®ä½¿ç”¨ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            fi
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹
            if grep -r -E "CreateObject.*Scripting\.FileSystemObject" src/excel/*.bas; then
              echo "â„¹ï¸  FileSystemObjectã®ä½¿ç”¨ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            fi
            
            echo "âœ… Excel VBA ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æå®Œäº†"
          else
            echo "â„¹ï¸  Excel VBA ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

  dependency-check:
    name: ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          if [ -f "package.json" ]; then
            npm install
          else
            echo "â„¹ï¸  package.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            exit 0
          fi

      - name: è„†å¼±æ€§ç›£æŸ»
        run: |
          echo "=== ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯ ==="
          npm audit --audit-level moderate || true
          echo "âœ… ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯å®Œäº†"

  file-integrity:
    name: ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§æ¤œè¨¼
        run: |
          echo "=== ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ ==="

          # ç–‘ã‚ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã®æ¤œå‡º
          echo "ğŸ” ç–‘ã‚ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡º:"
          if find . -type f \( -name "*.exe" -o -name "*.dll" -o -name "*.bat" -o -name "*.cmd" -o -name "*.scr" \) ! -path "./.git/*"; then
            echo "âš ï¸  å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          else
            echo "âœ… ç–‘ã‚ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi

          # å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡ºï¼ˆ5MBä»¥ä¸Šï¼‰
          echo "ğŸ” å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡º:"
          if find . -type f -size +5M ! -path "./.git/*" ! -path "./node_modules/*"; then
            echo "â„¹ï¸  å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          else
            echo "âœ… å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi

          echo "âœ… ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Œäº†"

  reporting:
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    runs-on: ubuntu-latest
    needs: [secret-scan, permission-analysis, dependency-check, file-integrity]
    if: always()

    steps:
      - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆ
        run: |
          echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æãƒ¬ãƒãƒ¼ãƒˆ ==="
          echo "æ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S JST')"
          echo "================================"
          echo "ğŸ”’ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³: ${{ needs.secret-scan.result }}"
          echo "ğŸ”‘ æ¨©é™åˆ†æ: ${{ needs.permission-analysis.result }}"
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯: ${{ needs.dependency-check.result }}"
          echo "ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§: ${{ needs.file-integrity.result }}"
          echo "================================"

          # å…¨ä½“çš„ãªçµæœåˆ¤å®š
          if [[ "${{ needs.secret-scan.result }}" == "success" && "${{ needs.permission-analysis.result }}" == "success" && "${{ needs.dependency-check.result }}" == "success" && "${{ needs.file-integrity.result }}" == "success" ]]; then
            echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
          else
            echo "âš ï¸  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ³¨æ„ãŒå¿…è¦ãªé …ç›®ãŒã‚ã‚Šã¾ã™"
            echo "è©³ç´°ã¯ã‚¸ãƒ§ãƒ–ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          fi
