name: CI - ã‚³ãƒ¼ãƒ‰å“è³ªãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-scan:
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: CodeQL åˆæœŸåŒ–
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        queries: security-and-quality

    - name: CodeQL åˆ†æå®Ÿè¡Œ
      uses: github/codeql-action/analyze@v3

  code-quality:
    name: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest

    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        npm init -y
        npm install --save-dev eslint @eslint/js

    - name: ESLintã§Google Apps Scriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
      run: |
        npx eslint "src/**/*.gs" --ext .gs,.js --format stylish || true

    - name: ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ã®æ¤œè¨¼
      run: |
        echo "=== ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ãƒã‚§ãƒƒã‚¯ ==="
        # å¿…é ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
        test -d "src/gsuite" || (echo "âŒ src/gsuite ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" && exit 1)
        test -d "src/outlook" || (echo "âŒ src/outlook ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" && exit 1)
        test -d "docs" || (echo "âŒ docs ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" && exit 1)
        echo "âœ… åŸºæœ¬ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã¯æ­£å¸¸ã§ã™"

    - name: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯
      run: |
        echo "=== ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ ==="
        # README.md ã®å­˜åœ¨ç¢ºèª
        test -f "README.md" || (echo "âŒ README.md ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" && exit 1)
        # å„ä¸»è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«README.mdãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        find src -type d -mindepth 1 -maxdepth 2 | while read dir; do
          if [ ! -f "$dir/README.md" ]; then
            echo "âš ï¸  $dir ã«README.mdãŒã‚ã‚Šã¾ã›ã‚“"
          fi
        done
        echo "âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹é€ ãƒã‚§ãƒƒã‚¯å®Œäº†"

  security-secrets:
    name: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest

    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: API ã‚­ãƒ¼ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®æ¤œå‡º
      run: |
        echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ ==="
        
        # API ã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œç´¢
        echo "ğŸ” API ã‚­ãƒ¼ã®æ¤œç´¢ä¸­..."
        if grep -r -E "api[_-]?key|API[_-]?KEY" --include="*.gs" --include="*.bas" --include="*.js" src/ | grep -v "YOUR_API_KEY_HERE" | grep -v "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«"; then
          echo "âš ï¸  æ½œåœ¨çš„ãªAPI ã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        else
          echo "âœ… å•é¡Œã®ã‚ã‚‹API ã‚­ãƒ¼ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
        fi
        
        # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œç´¢
        echo "ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æ¤œç´¢ä¸­..."
        if grep -r -E "password|Password|PASSWORD" --include="*.gs" --include="*.bas" --include="*.js" src/ | grep -v "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" | grep -v "ã‚³ãƒ¡ãƒ³ãƒˆ"; then
          echo "âš ï¸  æ½œåœ¨çš„ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        else
          echo "âœ… å•é¡Œã®ã‚ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
        fi
        
        # ãƒˆãƒ¼ã‚¯ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œç´¢
        echo "ğŸ” ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œç´¢ä¸­..."
        if grep -r -E "token|Token|TOKEN" --include="*.gs" --include="*.bas" --include="*.js" src/ | grep -v "Bearer Token" | grep -v "ãƒˆãƒ¼ã‚¯ãƒ³" | grep -v "ã‚³ãƒ¡ãƒ³ãƒˆ"; then
          echo "âš ï¸  æ½œåœ¨çš„ãªãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        else
          echo "âœ… å•é¡Œã®ã‚ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
        fi
        
        echo "âœ… ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"

  vba-analysis:
    name: VBA ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ
    runs-on: ubuntu-latest

    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: VBA ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
      run: |
        echo "=== VBA ãƒ•ã‚¡ã‚¤ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ ==="
        
        # VBAãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        if [ ! -d "src/outlook" ] || [ -z "$(find src/outlook -name '*.bas' -type f)" ]; then
          echo "â„¹ï¸  VBA ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          exit 0
        fi
        
        echo "ğŸ” VBA ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†æä¸­..."
        
        # ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ã®ãƒã‚§ãƒƒã‚¯
        if grep -r -E "Const.*API.*=.*\".*\"" src/outlook/*.bas | grep -v "YOUR_API_KEY_HERE"; then
          echo "âš ï¸  ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸAPIè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        else
          echo "âœ… ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
        fi
        
        # å±é™ºãªé–¢æ•°ã®ä½¿ç”¨ãƒã‚§ãƒƒã‚¯
        echo "ğŸ” å±é™ºãªé–¢æ•°ã®ä½¿ç”¨ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        if grep -r -E "Shell|CreateObject.*WScript|CreateObject.*Shell" src/outlook/*.bas; then
          echo "âš ï¸  æ½œåœ¨çš„ã«å±é™ºãªé–¢æ•°ã®ä½¿ç”¨ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        else
          echo "âœ… å±é™ºãªé–¢æ•°ã®ä½¿ç”¨ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
        fi
        
        echo "âœ… VBA åˆ†æå®Œäº†"

  summary:
    name: çµæœã‚µãƒãƒªãƒ¼
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality, security-secrets, vba-analysis]
    if: always()

    steps:
    - name: çµæœã‚µãƒãƒªãƒ¼è¡¨ç¤º
      run: |
        echo "=== CI å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼ ==="
        echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³: ${{ needs.security-scan.result }}"
        echo "ğŸ“ ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯: ${{ needs.code-quality.result }}"
        echo "ğŸ” ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³: ${{ needs.security-secrets.result }}"
        echo "ğŸ“‹ VBA åˆ†æ: ${{ needs.vba-analysis.result }}"
        echo "========================="
        
        if [[ "${{ needs.security-scan.result }}" == "success" && "${{ needs.code-quality.result }}" == "success" && "${{ needs.security-secrets.result }}" == "success" && "${{ needs.vba-analysis.result }}" == "success" ]]; then
          echo "âœ… ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"
        else
          echo "âš ï¸  ä¸€éƒ¨ã®ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        fi