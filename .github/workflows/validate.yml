name: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®šæ¤œè¨¼

on:
  push:
    paths:
      - '.github/workflows/**'
  pull_request:
    paths:
      - '.github/workflows/**'

jobs:
  validate-workflows:
    name: GitHub Actionsè¨­å®šæ¤œè¨¼
    runs-on: ubuntu-latest

    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
      run: |
        echo "=== GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ¤œè¨¼ ==="
        
        # YAMLæ§‹æ–‡ã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯
        for workflow in .github/workflows/*.yml; do
          if [ -f "$workflow" ]; then
            echo "ğŸ” $workflow ã‚’æ¤œè¨¼ä¸­..."
            # ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ãªYAMLæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
            if python3 -c "import yaml; yaml.safe_load(open('$workflow'))" 2>/dev/null; then
              echo "âœ… $workflow - YAMLæ§‹æ–‡OK"
            else
              echo "âŒ $workflow - YAMLæ§‹æ–‡ã‚¨ãƒ©ãƒ¼"
              exit 1
            fi
          fi
        done
        
        echo "âœ… å…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Œäº†"

    - name: å¿…é ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å­˜åœ¨ç¢ºèª
      run: |
        echo "=== å¿…é ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ç¢ºèª ==="
        
        # CIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å­˜åœ¨ç¢ºèª
        if [ -f ".github/workflows/ci.yml" ]; then
          echo "âœ… CI ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: å­˜åœ¨"
        else
          echo "âŒ CI ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å­˜åœ¨ç¢ºèª
        if [ -f ".github/workflows/security.yml" ]; then
          echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: å­˜åœ¨"
        else
          echo "âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        
        echo "âœ… å¿…é ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç¢ºèªå®Œäº†"

    - name: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®šè©³ç´°ãƒã‚§ãƒƒã‚¯
      run: |
        echo "=== ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®šè©³ç´°ãƒã‚§ãƒƒã‚¯ ==="
        
        # å¿…è¦ãªãƒˆãƒªã‚¬ãƒ¼ã®ç¢ºèª
        echo "ğŸ” ãƒˆãƒªã‚¬ãƒ¼è¨­å®šç¢ºèª..."
        if grep -q "pull_request" .github/workflows/ci.yml; then
          echo "âœ… CI: pull_request ãƒˆãƒªã‚¬ãƒ¼è¨­å®šæ¸ˆã¿"
        else
          echo "âš ï¸  CI: pull_request ãƒˆãƒªã‚¬ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
        
        if grep -q "schedule" .github/workflows/security.yml; then
          echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: schedule ãƒˆãƒªã‚¬ãƒ¼è¨­å®šæ¸ˆã¿"
        else
          echo "âš ï¸  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: schedule ãƒˆãƒªã‚¬ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¨©é™ã®ç¢ºèª
        echo "ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¨©é™ç¢ºèª..."
        if grep -q "security-events: write" .github/workflows/ci.yml; then
          echo "âœ… CI: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆæ›¸ãè¾¼ã¿æ¨©é™è¨­å®šæ¸ˆã¿"
        else
          echo "âš ï¸  CI: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆæ¨©é™ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
        
        echo "âœ… ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®šè©³ç´°ãƒã‚§ãƒƒã‚¯å®Œäº†"
        
    - name: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      run: |
        echo "=== è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ ==="
        
        # ESLintè¨­å®šã®å­˜åœ¨ç¢ºèª
        if [ -f ".eslintrc.json" ]; then
          echo "âœ… ESLintè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: å­˜åœ¨"
          if python3 -c "import json; json.load(open('.eslintrc.json'))" 2>/dev/null; then
            echo "âœ… ESLintè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: JSONæ§‹æ–‡OK"
          else
            echo "âŒ ESLintè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: JSONæ§‹æ–‡ã‚¨ãƒ©ãƒ¼"
            exit 1
          fi
        else
          echo "âŒ ESLintè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        
        # package.json ã®å­˜åœ¨ç¢ºèª
        if [ -f "package.json" ]; then
          echo "âœ… package.json: å­˜åœ¨"
          if python3 -c "import json; json.load(open('package.json'))" 2>/dev/null; then
            echo "âœ… package.json: JSONæ§‹æ–‡OK"
          else
            echo "âŒ package.json: JSONæ§‹æ–‡ã‚¨ãƒ©ãƒ¼"
            exit 1
          fi
        else
          echo "âŒ package.json: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        
        echo "âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Œäº†"